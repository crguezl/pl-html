<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2008 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Porting to Coffeescript</TITLE>
<META NAME="description" CONTENT="Porting to Coffeescript">
<META NAME="keywords" CONTENT="javascriptexamples">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="Generator" CONTENT="LaTeX2HTML v2008">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="mystyle.css">

<LINK REL="next" HREF="node99.html">
<LINK REL="previous" HREF="node97.html">
<LINK REL="up" HREF="node96.html">
<LINK REL="next" HREF="node99.html">
</HEAD>

<BODY >

<DIV CLASS="navigation">
<A NAME="tex2html2770"
  HREF="node99.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html2764"
  HREF="node96.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html2758"
  HREF="node97.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html2766"
  HREF="node100.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html2768"
  HREF="node103.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html2"
  HREF="http://nereida.deioc.ull.es/perlexamples/index.html"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="Apuntes de LPP"></A><A NAME="tex2html3"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5669"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle 2014/2015"></A><A NAME="tex2html4"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1104"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle 2013/2014"></A><A NAME="tex2html5"
  HREF="javascriptexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="ps"></A><A NAME="tex2html6"
  HREF="https://plus.google.com/u/0/communities/103299470687051533933"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="comunidad g+ PL1415"></A><A NAME="tex2html7"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html8"
  HREF="http://www.ull.es/view/centros/etsii/Grado_en_Ingenieria_Informatica/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html9"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html10"
  HREF="https://github.com/crguezl"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="crguezl at github"></A>
<BR>
<B> Sig:</B> <A NAME="tex2html2771"
  HREF="node99.html">Pruebas</A>
<B>Sup:</B> <A NAME="tex2html2765"
  HREF="node96.html">CoffeeScript y Express</A>
<B> Ant:</B> <A NAME="tex2html2759"
  HREF="node97.html">Getting Started</A>
<B> Con:</B> 
<A NAME="tex2html2766"
  HREF="node100.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>
<B> Ind:</B> 
<A NAME="tex2html2768"
  HREF="node103.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A>
<BR> <P>
</DIV>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsecciones</STRONG></A>

<UL CLASS="ChildLinks">
<LI><UL>
<LI><UL>
<LI><A NAME="tex2html2772"
  HREF="node98.html#SECTION06220010000000000000">Ejecución del Servidor</A>
</UL></UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H1><A NAME="SECTION06220000000000000000">
Porting to Coffeescript</A>
</H1>
At this point, let’s port our backend to coffeescript. 

<P>
You can install <code>js2coffee</code> via npm. So run the following:

<P>
<PRE>
npm -g install js2coffee
</PRE>
<PRE>
[~/src/coffee/coffeepress]$ js2coffee --version
2.0.3
[~/src/coffee/coffeepress]$ js2coffee --help
Usage:
    js2coffee FILES [options]

Options:
        --ast          prints the AST (for debugging)
    -V, --verbose      prints more AST stuff (used with --ast)
    -i, --indent N     indent by N spaces (default: 2)
    -i, --indent tab   indent by tabs

Modes:
        --compat       compatibility mode *
                       (implement workarounds to keep full compatibility)

Other options:
    -h, --help         print usage information
    -v, --version      show version info and exit
</PRE>

<P>
Vamos a convertir nuestros ficheros <code>*.js</code> a coffee:
<PRE>
~/src/coffee/coffeepress]$ ls *js **/*js bin/*
app.js          bin/www         routes/index.js routes/users.js
[~/src/coffee/coffeepress]$ js2coffee app.js &gt; app.coffee
[~/src/coffee/coffeepress]$ js2coffee routes/index.js &gt; routes/index.coffee
[~/src/coffee/coffeepress]$ js2coffee routes/users.js &gt; routes/users.coffee
</PRE>
Cuando probamos con el main obtenemos un error:
<PRE>
[~/src/coffee/coffeepress]$ js2coffee bin/www &gt; bin/www.coffee
bin/www:1:0: [error] Unexpected token ILLEGAL
</PRE>
El error es debido a la primera línea para la bash con la 
definición del intérprete:
<PRE>
[/tmp/coffeepress]$ cat -n bin/www 
 1  #!/usr/bin/env node
 2  
 3  /**
 4   * Module dependencies.
 5   */
 6  
 7  var app = require('../app');
 8  var debug = require('debug')('coffeepress:server');
 9  var http = require('http');
10  
11  /**
12   * Get port from environment and store in Express.
13   */
14  
15  var port = normalizePort(process.env.PORT || '3000');
16  app.set('port', port);
17  
18  /**
19   * Create HTTP server.
20   */
21  
22  var server = http.createServer(app);
23  
24  /**
25   * Listen on provided port, on all network interfaces.
26   */
27  
28  server.listen(port);
29  server.on('error', onError);
30  server.on('listening', onListening);
31  
32  /**
33   * Normalize a port into a number, string, or false.
34   */
35  
36  function normalizePort(val) {
37    var port = parseInt(val, 10);
38  
39    if (isNaN(port)) {
40      // named pipe
41      return val;
42    }
43  
44    if (port &gt;= 0) {
45      // port number
46      return port;
47    }
48  
49    return false;
50  }
51  
52  /**
53   * Event listener for HTTP server "error" event.
54   */
55  
56  function onError(error) {
57    if (error.syscall !== 'listen') {
58      throw error;
59    }
60  
61    var bind = typeof port === 'string'
62      ? 'Pipe ' + port
63      : 'Port ' + port
64  
65    // handle specific listen errors with friendly messages
66    switch (error.code) {
67      case 'EACCES':
68        console.error(bind + ' requires elevated privileges');
69        process.exit(1);
70        break;
71      case 'EADDRINUSE':
72        console.error(bind + ' is already in use');
73        process.exit(1);
74        break;
75      default:
76        throw error;
77    }
78  }
79  
80  /**
81   * Event listener for HTTP server "listening" event.
82   */
83  
84  function onListening() {
85    var addr = server.address();
86    var bind = typeof addr === 'string'
87      ? 'pipe ' + addr
88      : 'port ' + addr.port;
89    debug('Listening on ' + bind);
90  }
</PRE>

<P>
Obsérvense las líneas:
<PRE>
29  server.on('error', onError);
30  server.on('listening', onListening);
</PRE>

<P>
Many objects in Node emit events: 

<UL>
<LI>a <code>net.Server</code> emits an event each time a peer connects to it, 
</LI>
<LI>a <code>fs.readStream</code> emits an event when the file is opened. 
</LI>
</UL>
All objects which emit events are instances of 
<A NAME="tex2html408"
  HREF="https://nodejs.org/api/events.html">events.EventEmitter </A>.

<P>
Functions can then be attached to objects, to be executed when an event is
emitted. These functions are called <A NAME="11636"></A><SPAN  CLASS="textbf">listeners</SPAN>. 

<P>
Volviendo a nuestra traducción de <code>bin/www</code>, 
si comentamos la primera línea no se producen errores pero si 
que nos sale un warning:
<PRE>
~/src/coffee/coffeepress]$ js2coffee bin/www &gt; bin/www.coffee
bin/www:37:6: [warning] Variable shadowing ('port') is not fully supported in CoffeeScript
</PRE>
Si cambiamos todas las apariciones de la variable 
<code>port</code>  por p. ej. <code>lport</code>
en la definición de la función <code>normalizePort</code> el warning desaparece:
<PRE>
[~/src/coffee/coffeepress(master)]$ js2coffee bin/www &gt; bin/www.coffee 
[~/src/coffee/coffeepress(master)]$
</PRE>
pero cuando ejecutamos el servidor obtenemos un nuevo error:
<PRE>
[~/src/coffee/coffeepress(master)]$ coffee bin/www.coffee 
TypeError: undefined is not a function
  at Object.&lt;anonymous&gt; (/Users/casiano/local/src/coffee/coffeepress/bin/www.coffee:15:8)
  at Object.&lt;anonymous&gt; (/Users/casiano/local/src/coffee/coffeepress/bin/www.coffee:3:1)
  at Module._compile (module.js:456:26)
</PRE>

<P>
Movemos la función <code>normalizePort</code> antes de la definición de <code>port</code> y se arregla el asunto.

<P>

<H4><A NAME="SECTION06220010000000000000">
Ejecución del Servidor</A>
</H4>
  

<P>
<PRE>
[~/src/coffee/coffeepress(master)]$ coffee bin/www.coffee 
GET / 304 298.379 ms - -
GET /stylesheets/style.css 304 6.048 ms - -
</PRE>
Otra forma de ejecutar el servidor es instalar <code>nodemon</code>
<PRE>
npm install -g nodemon
</PRE>
y ejecutarlo así:
<PRE>
~/src/coffee/coffeepress(master)]$ nodemon bin/www.coffee
6 Apr 14:12:01 - [nodemon] v1.3.7
6 Apr 14:12:01 - [nodemon] to restart at any time, enter `rs`
6 Apr 14:12:01 - [nodemon] watching: *.*
6 Apr 14:12:01 - [nodemon] starting `coffee bin/www.coffee`
</PRE>
<code>Nodemon</code> (see
<A NAME="tex2html409"
  HREF="http://nodemon.io/">http://nodemon.io/</A>
)
is for use during development of a node.js based application.

<P>
<code>nodemon</code> will watch the files in the directory in which <code>nodemon</code> was started, and if any files change, <code>nodemon</code> will automatically restart your node application.

<P>
<code>nodemon</code> does not require any changes to your code or method of
development. <code>nodemon</code> simply wraps your node application and keeps an eye
on any files that have changed. Remember that <code>nodemon</code> is a replacement
wrapper for node, think of it as replacing the word "node" on the command
line when you run your script.

<P>
Otra forma de ejecutar programas escritos en coffee 
consiste en usar la posibilidad que existe de cargar
el coffee desde un programa JavaScript usando 
<code>coffee-script/register</code>. Modificamos <code>bin/www</code>
como sigue:
<PRE>
[~/src/coffee/coffeepress.bak(master)]$ cat bin/www
#!/usr/bin/env node
// Note the new way of requesting CoffeeScript since 1.7.x
require('coffee-script/register');
// This bootstraps your server main file
require('./www.coffee');
</PRE>
y ahora ejecutamos:
<PRE>
[~/src/coffee/coffeepress(master)]$ node bin/www
GET / 304 334.240 ms - -
GET /stylesheets/style.css 304 7.269 ms - -
</PRE>

<P>

<DIV CLASS="navigation"><HR>
<A NAME="tex2html2770"
  HREF="node99.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html2764"
  HREF="node96.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html2758"
  HREF="node97.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html2766"
  HREF="node100.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html2768"
  HREF="node103.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> <A NAME="tex2html2"
  HREF="http://nereida.deioc.ull.es/perlexamples/index.html"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="logoLPP.png"
 ALT="Apuntes de LPP"></A><A NAME="tex2html3"
  HREF="https://campusvirtual.ull.es/1415/course/view.php?id=5669"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle 2014/2015"></A><A NAME="tex2html4"
  HREF="http://campusvirtual.ull.es/1314/course/view.php?id=1104"><IMG
  WIDTH="50" ALIGN="BOTTOM" BORDER="0"
 SRC="moodleLHPlogo.jpeg"
 ALT="PL moodle 2013/2014"></A><A NAME="tex2html5"
  HREF="javascriptexamples.pdf"><IMG
  WIDTH="30" ALIGN="BOTTOM" BORDER="0"
 SRC="gv.jpeg"
 ALT="ps"></A><A NAME="tex2html6"
  HREF="https://plus.google.com/u/0/communities/103299470687051533933"><IMG
  WIDTH="27" ALIGN="BOTTOM" BORDER="0"
 SRC="perl6.jpg"
 ALT="comunidad g+ PL1415"></A><A NAME="tex2html7"
  HREF="http://www.google.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ggoogle.gif"
 ALT="google"></A><A NAME="tex2html8"
  HREF="http://www.ull.es/view/centros/etsii/Grado_en_Ingenieria_Informatica/es"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="etsii.png"
 ALT="etsii"></A><A NAME="tex2html9"
  HREF="http://www.ull.es/"><IMG
  WIDTH="35" ALIGN="BOTTOM" BORDER="0"
 SRC="ull.gif"
 ALT="ull"></A><A NAME="tex2html10"
  HREF="https://github.com/crguezl"><IMG
  WIDTH="32" ALIGN="BOTTOM" BORDER="0"
 SRC="logopcgull.gif"
 ALT="crguezl at github"></A>
<BR>
<B> Sig:</B> <A NAME="tex2html2771"
  HREF="node99.html">Pruebas</A>
<B>Sup:</B> <A NAME="tex2html2765"
  HREF="node96.html">CoffeeScript y Express</A>
<B> Ant:</B> <A NAME="tex2html2759"
  HREF="node97.html">Getting Started</A>
</DIV>
<!--End of Navigation Panel-->
<ADDRESS>
<I>Casiano Rodríguez León <BR>
2015-04-12</I>
</ADDRESS>
</BODY>
</HTML>
